name: CI - Validation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v6

      - name: Use Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "18.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: dist
          path: dist/

  security:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v6

      - name: Use Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "18.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for secrets
        run: |
          echo "üîç Scanning for hardcoded secrets..."
          ! git grep -E "password\s*=\s*['\"][^'\"]+['\"]" -- ':!*.md' ':!SECURITY.md' || (echo "‚ùå Found hardcoded passwords" && exit 1)
          ! git grep -E "api[_-]?key\s*=\s*['\"][^'\"]+['\"]" -- ':!*.md' ':!SECURITY.md' || (echo "‚ùå Found hardcoded API keys" && exit 1)
          echo "‚úÖ No secrets detected"

  smoke-test:
    needs: [build]
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v6

      - name: Use Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "18.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v5
        with:
          name: dist
          path: dist/

      - name: Run Smoke Test
        env:
          CLIENT: "latam"
          TEST: "example.ts"
          ENV: "default"
        run: |
          echo "üöÄ Running k6 smoke test..."
          node dist/core/cli.js --client="$CLIENT" --test="$TEST" --env="$ENV" || TEST_FAILED=true

          # Display beautiful summary
          chmod +x bin/reporting/test-summary.sh
          TEST_NAME=$(echo "$TEST" | sed 's/\.ts$//')
          ./bin/reporting/test-summary.sh reports "$CLIENT" "$TEST_NAME" || true

          if [ "$TEST_FAILED" = "true" ]; then
            echo "‚ùå Test failed!"
            exit 1
          fi
          echo "‚úÖ Test passed!"

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: k6-reports
          path: reports/
          retention-days: 30

  publish-docker:
    needs: [build, security]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v6

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
