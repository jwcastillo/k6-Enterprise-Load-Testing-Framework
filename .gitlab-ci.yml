# You can override the included template(s) by including variable overrides
# SAST customization: https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Secret Detection customization: https://docs.gitlab.com/user/application_security/secret_detection/pipeline/configure
# Dependency Scanning customization: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/#customizing-the-dependency-scanning-settings
# Container Scanning customization: https://docs.gitlab.com/ee/user/application_security/container_scanning/#customizing-the-container-scanning-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#cicd-variable-precedence
image: node:18
stages:
  - build
  - security
  - test
  - secret-detection
cache:
  paths:
    - node_modules/
build:
  stage: build
  script:
    - npm ci
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  only:
    - branches
    - merge_requests
security:audit:
  stage: security
  script:
    - npm ci
    - npm audit --audit-level=moderate || true
  allow_failure: true
  only:
    - branches
    - merge_requests
security:secrets:
  stage: security
  script:
    - "echo \"\U0001F50D Scanning for hardcoded secrets...\"\n! git grep -E \"password\\s*=\\s*['\\\"][\\^'\\\"]+['\\\"]\"
      -- ':!*.md' ':!SECURITY.md' || (echo \"❌ Found hardcoded passwords\" && exit 1)\n!
      git grep -E \"api[_-]?key\\s*=\\s*['\\\"][^'\\\"]+['\\\"]\" -- ':!*.md' ':!SECURITY.md'
      || (echo \"❌ Found hardcoded API keys\" && exit 1)\necho \"✅ No secrets detected\"\n"
  allow_failure: false
  only:
    - branches
    - merge_requests
lint:typescript:
  stage: security
  script:
    - npm ci
    - npx tsc --noEmit
  allow_failure: false
  only:
    - branches
    - merge_requests
".test_template":
  stage: test
  image: grafana/k6:latest
  before_script:
    - apk add --no-cache nodejs npm bash
    - npm ci
  script:
    - "CLIENT=\"${CLIENT:-local}\"\nTEST=\"${TEST:-example.ts}\"\nENV=\"${ENV:-default}\"\necho
      \"\U0001F680 Running k6 test...\"\necho \"   Client: $CLIENT\"\necho \"   Test:
      $TEST\"\necho \"   Environment: $ENV\"\necho \"\"\n\nnode dist/core/cli.js --client=\"$CLIENT\"
      --test=\"$TEST\" --env=\"$ENV\" || TEST_FAILED=true\n\n# Display beautiful summary\nchmod
      +x bin/test-summary.sh\nTEST_NAME=$(echo \"$TEST\" | sed 's/\\.ts$//')\n./bin/test-summary.sh
      reports \"$CLIENT\" \"$TEST_NAME\" || true\n\n# Exit with test result\nif [ \"$TEST_FAILED\"
      = \"true\" ]; then\n  echo \"❌ Test failed!\"\n  exit 1\nfi\n\necho \"✅ Test passed!\"\n"
  artifacts:
    name: k6-reports-${CLIENT}-${TEST}-$CI_COMMIT_SHORT_SHA
    when: always
    expire_in: 30 days
    paths:
      - reports/**/*.json
      - reports/**/*.html
      - reports/**/*.txt
      - reports/**/*.log
      - reports/**/*.png
      - reports/**/*.jpg
      - reports/**/*.jpeg
  allow_failure: false
run:test:
  stage: test
  image: grafana/k6:latest
  before_script:
    - apk add --no-cache nodejs npm bash
    - npm ci
  script:
    - "CLIENT=\"${CLIENT:-local}\"\nTEST=\"${TEST:-example.ts}\"\nENV=\"${ENV:-default}\"\necho
      \"\U0001F680 Running k6 test...\"\necho \"   Client: $CLIENT\"\necho \"   Test:
      $TEST\"\necho \"   Environment: $ENV\"\necho \"\"\n\nnode dist/core/cli.js --client=\"$CLIENT\"
      --test=\"$TEST\" --env=\"$ENV\" || TEST_FAILED=true\n\n# Display beautiful summary\nchmod
      +x bin/test-summary.sh\nTEST_NAME=$(echo \"$TEST\" | sed 's/\\.ts$//')\n./bin/test-summary.sh
      reports \"$CLIENT\" \"$TEST_NAME\" || true\n\n# Exit with test result\nif [ \"$TEST_FAILED\"
      = \"true\" ]; then\n  echo \"❌ Test failed!\"\n  exit 1\nfi\n\necho \"✅ Test passed!\"\n"
  artifacts:
    name: k6-reports-${CLIENT}-${TEST}-$CI_COMMIT_SHORT_SHA
    when: always
    expire_in: 30 days
    paths:
      - reports/**/*.json
      - reports/**/*.html
      - reports/**/*.txt
      - reports/**/*.log
      - reports/**/*.png
      - reports/**/*.jpg
      - reports/**/*.jpeg
  allow_failure: false
  needs:
    - build
  variables:
    CLIENT: local
    TEST: example.ts
    ENV: default
  when: manual
  only:
    - web

test:smoke:
  <<: *test_template
  stage: test
  needs: [build]
  variables:
    CLIENT: "latam"
    TEST: "example.ts"
    ENV: "default"
  only:
    - branches
    - merge_requests

sast:
  stage: test
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
secret_detection:
  stage: secret-detection
