# You can override the included template(s) by including variable overrides
# SAST customization: https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Secret Detection customization: https://docs.gitlab.com/user/application_security/secret_detection/pipeline/configure
# Dependency Scanning customization: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/#customizing-the-dependency-scanning-settings
# Container Scanning customization: https://docs.gitlab.com/ee/user/application_security/container_scanning/#customizing-the-container-scanning-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#cicd-variable-precedence
image: node:18
stages:
  - build
  - security
  - test
  - secret-detection
cache:
  paths:
    - node_modules/
build:
  stage: build
  script:
    - npm ci
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  only:
    - branches
    - merge_requests
security:audit:
  stage: security
  script:
    - npm ci
    - npm audit --audit-level=moderate || true
  allow_failure: true
  only:
    - branches
    - merge_requests
security:secrets:
  stage: security
  script:
    - |
      echo "üîç Scanning for hardcoded secrets..."
      ! git grep -E "password\s*=\s*['\"][^'\"]+['\"]" -- ':!*.md' ':!SECURITY.md' || (echo "‚ùå Found hardcoded passwords" && exit 1)
      ! git grep -E "api[_-]?key\s*=\s*['\"][^'\"]+['\"]" -- ':!*.md' ':!SECURITY.md' || (echo "‚ùå Found hardcoded API keys" && exit 1)
      echo "‚úÖ No secrets detected"
  allow_failure: false
  only:
    - branches
    - merge_requests
lint:typescript:
  stage: security
  script:
    - npm ci
    - npx tsc --noEmit
  allow_failure: false
  only:
    - branches
    - merge_requests

# Test template using run-test.sh wrapper
.test_template: &test_template
  stage: test
  image: grafana/k6:latest
  before_script:
    - apk add --no-cache nodejs npm bash
    - npm ci
    - npm run build
  script:
    - |
      CLIENT="${CLIENT:-local}"
      TEST="${TEST:-example.ts}"
      ENV="${ENV:-default}"

      echo "üöÄ Running k6 test with run-test.sh wrapper..."
      echo "   Client: $CLIENT"
      echo "   Test: $TEST"
      echo "   Environment: $ENV"
      echo ""

      chmod +x bin/testing/run-test.sh
      ./bin/testing/run-test.sh --client="$CLIENT" --test="$TEST" --env="$ENV"
  artifacts:
    name: k6-reports-${CLIENT}-${TEST}-$CI_COMMIT_SHORT_SHA
    when: always
    expire_in: 30 days
    paths:
      - reports/**/*.json
      - reports/**/*.html
      - reports/**/*.txt
      - reports/**/*.log
      - reports/**/*.png
      - reports/**/*.jpg
      - reports/**/*.jpeg
  allow_failure: false

run:test:
  <<: *test_template
  needs: [build]
  variables:
    CLIENT: "local"
    TEST: "example.ts"
    ENV: "default"
  when: manual
  only:
    - web

test:smoke:
  <<: *test_template
  stage: test
  needs: [build]
  variables:
    CLIENT: "latam"
    TEST: "example.ts"
    ENV: "default"
  only:
    - branches
    - merge_requests

sast:
  stage: test
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
secret_detection:
  stage: secret-detection
