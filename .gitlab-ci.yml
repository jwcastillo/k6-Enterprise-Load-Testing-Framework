image: node:18

stages:
  - build
  - security
  - test

cache:
  paths:
    - node_modules/

# Validation Pipeline (runs on push/MR)
build:
  stage: build
  script:
    - npm ci
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  only:
    - branches
    - merge_requests

security:audit:
  stage: security
  script:
    - npm ci
    - npm audit --audit-level=moderate || true
  allow_failure: true
  only:
    - branches
    - merge_requests

security:secrets:
  stage: security
  script:
    - |
      echo "üîç Scanning for hardcoded secrets..."
      ! git grep -E "password\s*=\s*['\"][\^'\"]+['\"]" -- ':!*.md' ':!SECURITY.md' || (echo "‚ùå Found hardcoded passwords" && exit 1)
      ! git grep -E "api[_-]?key\s*=\s*['\"][^'\"]+['\"]" -- ':!*.md' ':!SECURITY.md' || (echo "‚ùå Found hardcoded API keys" && exit 1)
      echo "‚úÖ No secrets detected"
  allow_failure: false
  only:
    - branches
    - merge_requests

lint:typescript:
  stage: security
  script:
    - npm ci
    - npx tsc --noEmit
  allow_failure: false
  only:
    - branches
    - merge_requests

# On-Demand Test Execution (manual trigger only)
.test_template: &test_template
  stage: test
  image: grafana/k6:latest
  before_script:
    - apk add --no-cache nodejs npm bash
    - npm ci
  script:
    - |
      CLIENT="${CLIENT:-local}"
      TEST="${TEST:-example.ts}"
      ENV="${ENV:-default}"
      echo "üöÄ Running k6 test..."
      echo "   Client: $CLIENT"
      echo "   Test: $TEST"
      echo "   Environment: $ENV"
      echo ""

      node dist/core/cli.js --client="$CLIENT" --test="$TEST" --env="$ENV" || TEST_FAILED=true

      # Display beautiful summary
      chmod +x bin/test-summary.sh
      TEST_NAME=$(echo "$TEST" | sed 's/\.ts$//')
      ./bin/test-summary.sh reports "$CLIENT" "$TEST_NAME" || true

      # Exit with test result
      if [ "$TEST_FAILED" = "true" ]; then
        echo "‚ùå Test failed!"
        exit 1
      fi

      echo "‚úÖ Test passed!"
  artifacts:
    name: "k6-reports-${CLIENT}-${TEST}-$CI_COMMIT_SHORT_SHA"
    when: always
    expire_in: 30 days
    paths:
      - reports/**/*.json
      - reports/**/*.html
      - reports/**/*.txt
      - reports/**/*.log
      - reports/**/*.png
      - reports/**/*.jpg
      - reports/**/*.jpeg
  allow_failure: false

run:test:
  <<: *test_template
  needs: [build]
  variables:
    CLIENT: "local"
    TEST: "example.ts"
    ENV: "default"
  when: manual
  only:
    - web
