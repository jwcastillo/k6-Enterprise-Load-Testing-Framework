image: node:18

stages:
  - build
  - test

cache:
  paths:
    - node_modules/

build:
  stage: build
  script:
    - npm ci
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour

variables:
  CLIENT: "client-a"
  ENV: "default"
  TEST: "example.ts"
  PROFILE: "smoke"

test:
  stage: test
  needs: [build]
  image: grafana/k6:latest
  before_script:
    - apk add --no-cache nodejs npm bash
    - npm ci
  script:
    - |
      CLIENT="${CLIENT:-local}"
      TEST="${TEST:-example.ts}"
      echo "Running test: Client=$CLIENT, Test=$TEST"
      node dist/core/cli.js --client="$CLIENT" --test="$TEST" || TEST_FAILED=true

      # Display beautiful summary
      chmod +x bin/test-summary.sh
      TEST_NAME=$(echo "$TEST" | sed 's/\.ts$//')
      ./bin/test-summary.sh reports "$CLIENT" "$TEST_NAME" || true

      # Exit with test result
      if [ "$TEST_FAILED" = "true" ]; then
        exit 1
      fi
  artifacts:
    name: "k6-test-reports-$CI_COMMIT_SHORT_SHA"
    when: always
    expire_in: 30 days
    paths:
      - reports/**/*.json
      - reports/**/*.html
      - reports/**/*.txt
      - reports/**/*.log
      - reports/**/*.png
      - reports/**/*.jpg
      - reports/**/*.jpeg
    reports:
      junit: reports/**/junit.xml
  allow_failure: false
